name: 'Draft Release v1.4.0'

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: write

jobs:
  linux:
    uses: ./.github/workflows/build_linux.yml
    with:
      TAG:  ${{ github.ref_name }}
  windows:
    uses: ./.github/workflows/build_windows.yml
    with:
      TAG:  ${{ github.ref_name }}
  macos:
    uses: ./.github/workflows/build_macOS.yml
    with:
      TAG:  ${{ github.ref_name }}
  release:
    name: Create Release Draft
    needs: [linux, windows, macos]
    runs-on: ubuntu-latest
    outputs:
      changelog-section: ${{ steps.extract.outputs.changelog_section }}
    env:
      TAG: ${{ github.ref_name }}
    steps:
    - name: Checkout
      uses: actions/checkout@v5
    - name: Download Linux binary
      uses: actions/download-artifact@v4
      with:
        name: LinuxBIN
    - name: Download Windows executable
      uses: actions/download-artifact@v4
      with:
        name: WindowsEXE
    - name: Download Windows zipped folder
      uses: actions/download-artifact@v4
      with:
        name: WindowsZIP
    - name: Download Windows-arm executable
      uses: actions/download-artifact@v4
      with:
        name: WinarmEXE
    - name: Download Windows-arm zipped folder
      uses: actions/download-artifact@v4
      with:
        name: WinarmZIP
    - name: Download macOS app
      uses: actions/download-artifact@v4
      with:
        name: MacAPP
    - name: Download macOS-old app
      uses: actions/download-artifact@v4
      with:
        name: MacAPP-old
    - name: Extract section from changelog
      id: extract
      env:
        CHANGELOG_FILE: "CHANGELOG.md"
      run: |
        if [[ ! -f "$CHANGELOG_FILE" ]]; then
          echo "Error: File '$CHANGELOG_FILE' not found!"
          exit 1
        fi
        changelog_section=$(awk '
        /^## / { h2_count++ } 
        h2_count == 2 && !/^## / && !/^$/ { in_section = 1 } 
        h2_count == 3 { in_section = 0 } 
        in_section { 
            if (/^[[:space:]]*$/) { 
                empty_buffer = empty_buffer $0 "\n" 
            } else { 
                printf "%s", empty_buffer 
                empty_buffer = "" 
                print 
            } 
        }
        ' "$CHANGELOG_FILE")
        echo "changelog_section<<EOF" >> $GITHUB_OUTPUT
        echo "$changelog_section" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    - name: Create release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
        draft: true
        prerelease: false
        body: |
          ${{ steps.extract.outputs.changelog_section }}
          ____
          These self-contained packages don't require the installation of Python or any dependencies:
          - Linux:
            - Stand-alone: [JWLManager_${{ github.ref_name }}](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/JWLManager_${{ github.ref_name }}-x86_64)
          - Windows 10/11:
            - Stand-alone: [JWLManager_${{ github.ref_name }}-amd64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/JWLManager_${{ github.ref_name }}-amd64.exe)
            - Zipped folder[^1]: [JWLManager_${{ github.ref_name }}-amd64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/JWLManager_${{ github.ref_name }}-amd64.zip)
          - Windows 10/11 (ARM or older Intel CPUs that don't work with the above):
            - Stand-alone: [JWLManager_${{ github.ref_name }}-arm64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/JWLManager_${{ github.ref_name }}-arm64.exe)
            - Zipped folder[^1]: [JWLManager_${{ github.ref_name }}-arm64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/JWLManager_${{ github.ref_name }}-arm64.zip)
          - macOS:
            - Intel (x86_64): [JWLManager_${{ github.ref_name }}-x86_64.app.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/JWLManager_${{ github.ref_name }}-x86_64.app.zip)
            - Apple Silicon (arm64): [JWLManager_${{ github.ref_name }}-arm64.app.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/JWLManager_${{ github.ref_name }}-arm64.app.zip)
          ____
          [^1]: Console enabled; can be launched from commandline with arguments. See `JWLManager.exe -h`.
        files: |
          JWLManager_${{ github.ref_name }}-x86_64
          JWLManager_${{ github.ref_name }}-amd64.exe
          JWLManager_${{ github.ref_name }}-amd64.zip
          JWLManager_${{ github.ref_name }}-arm64.exe
          JWLManager_${{ github.ref_name }}-arm64.zip
          JWLManager_${{ github.ref_name }}-arm64.app.zip
          JWLManager_${{ github.ref_name }}-x86_64.app.zip
